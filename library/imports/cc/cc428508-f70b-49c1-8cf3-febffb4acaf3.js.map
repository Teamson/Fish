{"version":3,"sources":["assets\\Scripts\\Crl\\Prop\\Needle.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import PlayerDataMgr from \"../../Libs/PlayerDataMgr\";\r\nimport Utility from \"../../Mod/Utility\";\r\nimport LevelBase from \"../Level/LevelBase\";\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nexport default class Needle extends cc.Component {\r\n\r\n    @property\r\n    lostHead: boolean = false\r\n    @property\r\n    onceTrigger: boolean = false\r\n    @property\r\n    isAwake: boolean = true\r\n    @property\r\n    twiceRemove: boolean = false\r\n\r\n    needle: cc.Node = null\r\n    pointNode: cc.Node = null\r\n\r\n    isTouching: boolean = false\r\n\r\n    switchState: number = 0\r\n    myDir: cc.Vec2 = cc.v2(0, 0)\r\n    middlePos: cc.Vec2 = cc.v2(0, 0)\r\n    touchStartPos: cc.Vec2 = cc.v2(0, 0)\r\n    needleStartPos: cc.Vec2 = cc.v2(0, 0)\r\n\r\n    myId: number = 0\r\n    needleLength: number = 0\r\n\r\n    onLoad() {\r\n        this.myId = this.node.parent.children.indexOf(this.node)\r\n        this.needle = this.node.getChildByName('needle')\r\n        this.myDir = cc.v2(this.needle.right.x, this.needle.right.y)\r\n        this.pointNode = this.node.getChildByName('pointNode')\r\n        let lastPoint = this.pointNode.children[this.pointNode.childrenCount - 1]\r\n        this.needleLength = Utility.getWorldDis(lastPoint, this.needle)\r\n        this.middlePos = this.needle.getPosition().add(this.myDir.mul(this.needleLength / 2))\r\n        this.needleStartPos = this.needle.getPosition()\r\n\r\n        this.needle.width += 100\r\n    }\r\n\r\n    start() {\r\n        this.needle.on(cc.Node.EventType.TOUCH_START, this.touchStart, this)\r\n        this.needle.on(cc.Node.EventType.TOUCH_MOVE, this.touchMove, this)\r\n        this.needle.on(cc.Node.EventType.TOUCH_END, this.touchEnd, this)\r\n        this.needle.on(cc.Node.EventType.TOUCH_CANCEL, this.touchEnd, this)\r\n    }\r\n\r\n    touchStart(event: cc.Event.EventTouch) {\r\n        if (this.isTouching || !LevelBase.Share.canTouch || this.lostHead || !this.isAwake) return\r\n        this.isTouching = true\r\n\r\n        let pos = event.getLocation()\r\n        this.touchStartPos = pos\r\n    }\r\n\r\n    touchMove(event: cc.Event.EventTouch) {\r\n        if (!LevelBase.Share.canTouch || this.lostHead || !this.isAwake) return\r\n        let pos = event.getLocation()\r\n\r\n        let touchDir = pos.sub(this.touchStartPos).normalizeSelf()\r\n        let angle = cc.misc.radiansToDegrees(touchDir.angle(this.myDir))\r\n        let isRight = Math.abs(angle) <= 90\r\n\r\n        let dt = pos.sub(this.touchStartPos).mag()\r\n        dt = dt > 30 ? 30 : dt\r\n        dt = isRight ? dt : -dt\r\n\r\n        let desPos = this.needle.getPosition().add(this.myDir.mul(dt))\r\n        if (desPos.sub(this.middlePos).mag() < this.needleLength / 2)\r\n            this.needle.setPosition(desPos)\r\n\r\n        this.checkIsTrigger()\r\n        this.touchStartPos = pos\r\n    }\r\n\r\n    touchEnd(event: cc.Event.EventTouch) {\r\n        if (!LevelBase.Share.canTouch || this.lostHead || !this.isAwake) return\r\n        this.isTouching = false\r\n    }\r\n\r\n    checkIsTrigger() {\r\n        for (let i = 0; i < this.pointNode.childrenCount; i++) {\r\n            let p = this.pointNode.children[i]\r\n            if (p.active && Utility.getWorldDis(p, this.needle) <= 50) {\r\n                if (this.onceTrigger) {\r\n                    this.node.active = false\r\n                    this.switchState = 2\r\n                } else {\r\n                    this.switchState = i + 1\r\n                    this.needle.setPosition(p.getPosition())\r\n                    if (this.twiceRemove && this.switchState == 2) {\r\n                        this.node.active = false\r\n                    }\r\n                }\r\n\r\n                this.pointNode.children.forEach((c) => { c.active = true })\r\n                p.active = false\r\n                LevelBase.Share.triggerNeedle(this.myId, i)\r\n                break\r\n            }\r\n        }\r\n        if (this.switchState != 0) {\r\n            if (this.needle.getPosition().sub(this.needleStartPos).mag() <= 20) {\r\n                this.switchState = 0\r\n                this.needle.setPosition(this.needleStartPos)\r\n                this.pointNode.children.forEach((c) => { c.active = true })\r\n            }\r\n        }\r\n    }\r\n\r\n    update(dt) {\r\n        if (this.node.getComponentInChildren(cc.RigidBody)) {\r\n            this.node.getComponentInChildren(cc.RigidBody).syncPosition(true)\r\n        }\r\n    }\r\n}\r\n"]}